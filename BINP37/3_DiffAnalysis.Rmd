---
title: "3_DiffAnalysis"
output: pdf_document
date: "2024-04-08"
description: ADD 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Install necessary packages
install.packages("data.table")
install.packages("dplyr")
library(data.table)
library(dplyr)
```

## Determine PSI Variation Between Samples 

```{r}
# Convert and remove rows with NaN/NAN values: 21159 -> 10578
converted_PSI_scores <- PSI_scores %>%
  # Convert non-numeric values to NA
  mutate(across(S000001:S006786, convert_to_na)) %>% 
  mutate(across(S000001:S006786, as.numeric)) %>%
  # Calculate the number of NA values in each row
  mutate(num_na = rowSums(is.na(select(., -Location, -Gene_Name, -AS_Type)))) %>%
  # Conditionally remove rows with 748 or more NA's
  filter(num_na < 748 | is.na(num_na)) %>%
  select(-num_na)  # Remove the num_na column if no longer needed

# Determine frequency of NAs in each row 
mean(test$num_na) #1217
median(test$num_na) #748- filter based on this 

# Define the column range to be checked
column_range <- 4:ncol(converted_PSI_scores) 

```

## Remove Samples With No Variation

```{r}
# Remove rows where all values are the same (0,1 or any constant):
filtered_PSI_scores <- converted_PSI_scores[apply(converted_PSI_scores[, column_range], 1, function(row) length(unique(na.omit(row))) > 1), ] #removed 721 rows, left with 9857 events and 405 genes  

# Melt remaining PSI scores:  
melted_PSI_scores <- melt(filtered_PSI_scores, na.rm = F, id.vars = c("Location", "Gene_Name", "AS_Type"), variable.name = "Sample", value.name = "PSI_Score")

# Filter out PSI scores of 0 and 1
melted_strict <- melted_PSI_scores %>%
  filter(PSI_Score != 0 & PSI_Score != 1)

# Determine how many genes we are left with for analysis 
melted_strict %>%
  group_by(Gene_Name) %>%
  count() # 405 genes from 9855 events 

```

## Combine PSI Score and Patient Datasets

```{r}
# Extract ER, PR, and HER2 status and Subtype 
ER_PR_HER2_status <- filtered_patient_data %>%
  select(Sample, ER, PR, HER2, NCN.PAM50) %>%
  rename(NCN_PAM50 = NCN.PAM50)

# Count NAs to be excluded from analysis! 
ER_PR_HER2_status %>%
  filter(is.na(ER)) %>% # 17 
  count()

ER_PR_HER2_status %>%
  filter(is.na(PR)) %>% #17 
  count()

ER_PR_HER2_status %>%
  filter(is.na(HER2)) %>% # 59 
  count()

# Join PSI scores and ER status by Sample ID 
merged_PSI_ER_PR_HER2 <- left_join(melted_strict,ER_PR_HER2_status, by = "Sample")

```

## Summary Statistics 

```{r}
# Summary statistics for ER positive vs negative 
group_by(merged_PSI_ER_PR_HER2, ER) %>%
  summarise(
    count = n_distinct(Sample),
    mean = mean(PSI_Score, na.rm = TRUE),
    sd = sd(PSI_Score, na.rm = TRUE),
    median = median(PSI_Score, na.rm = TRUE),
    IQR = IQR(PSI_Score, na.rm = TRUE)
  )

# Summary statistics for PR positive vs negative 
group_by(merged_PSI_ER_PR_HER2, PR) %>%
  summarise(
    count = n_distinct(Sample),
    mean = mean(PSI_Score, na.rm = TRUE),
    sd = sd(PSI_Score, na.rm = TRUE),
    median = median(PSI_Score, na.rm = TRUE),
    IQR = IQR(PSI_Score, na.rm = TRUE)
  )

# Summary statistics for HER2 positive vs negative 
group_by(merged_PSI_ER_PR_HER2, HER2) %>%
  summarise(
    count = n_distinct(Sample),
    mean = mean(PSI_Score, na.rm = TRUE),
    sd = sd(PSI_Score, na.rm = TRUE),
    median = median(PSI_Score, na.rm = TRUE),
    IQR = IQR(PSI_Score, na.rm = TRUE)
  )
  
# Make boxplots 
merged_PSI_ER_PR_HER2 %>%
  na.omit() %>%
  group_by(ER) %>%
  ggplot(aes(x = ER, y = PSI_Score)) +
  geom_boxplot() +
  labs(x = "ER Status",
       y = "PSI Score",
       title = "ER Positive vs Negative")

merged_PSI_ER_PR_HER2 %>%
  na.omit() %>%
  group_by(PR) %>%
  ggplot(aes(x = PR, y = PSI_Score)) +
  geom_boxplot() +
  labs(x = "PR Status",
       y = "PSI Score",
       title = "PR Positive vs Negative")

merged_PSI_ER_PR_HER2 %>%
  na.omit() %>%
  group_by(HER2) %>%
  ggplot(aes(x = HER2, y = PSI_Score)) +
  geom_boxplot() +
  labs(x = "HER2 Status",
       y = "PSI Score",
       title = "HER2 Positive vs Negative")

```

## Set Up for Mann Whitney Tests

```{r}
# All unique AS Events to be analyzed (9855)
unique_locations <- unique(merged_PSI_ER_PR_HER2$Location)

# Initialize an empty dataframe to store events with only 1 observation
missing_events <- data.frame(event = character(), stringsAsFactors = FALSE)

# Create empty dataframes to store results
ER_mw_results <- data.frame(
  Location = character(),
  ER_positive_mean = double(),
  ER_negative_mean = double(),
  p_value = double(),
  q_value = double()
)

PR_mw_results <- data.frame(
  Location = character(),
  PR_positive_mean = double(),
  PR_negative_mean = double(),
  p_value = double(),
  q_value = double()
)

HER2_mw_results <- data.frame(
  Location = character(),
  HER2_positive_mean = double(),
  HER2_negative_mean = double(),
  p_value = double(),
  q_value = double()
)

# Initialize dataframes
ER_mw_results <- data.frame(Location = character(),
                            ER_positive_mean = numeric(),
                            ER_negative_mean = numeric(),
                            p_value = numeric())

PR_mw_results <- data.frame(Location = character(),
                            PR_positive_mean = numeric(),
                            PR_negative_mean = numeric(),
                            p_value = numeric())

HER2_mw_results <- data.frame(Location = character(),
                            HER2_positive_mean = numeric(),
                            HER2_negative_mean = numeric(),
                            p_value = numeric())
```

## ER Positive vs Negative- NEW 

```{r}
# Loop through each unique location and perform Mann-Whitney test
for (event in unique_locations) {
  # Filter data for the current event
  data <- merged_PSI_ER_PR_HER2 %>%
    filter(Location == event) %>%
    na.omit()
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    missing_events <- rbind(missing_events, data.frame(event = event))
    next
    
  } else if (length(unique(data$ER)) == 2) {
    # Perform Mann-Whitney test with handling ties
    mw_test <- wilcox.test(PSI_Score ~ ER, data = data, exact = FALSE)
    
    # Calculate means for ER in positive and negative groups
    ER_positive_mean <- mean(data$PSI_Score[data$ER == "Positive"])  
    ER_negative_mean <- mean(data$PSI_Score[data$ER == "Negative"])
    
    # Write results to data frame
    result <- data.frame(
      Location = event,
      ER_positive_mean = ER_positive_mean,
      ER_negative_mean = ER_negative_mean,
      p_value = mw_test$p.value
    )
  } else if (length(unique(data$ER)) == 1) {
    # Calculate mean PSI score for the single ER value
    ER_mean <- mean(data$PSI_Score)
    
    # Write results to data frame with NA for other columns
    result <- data.frame(
      Location = event,
      ER_positive_mean = ifelse(unique(data$ER) == "Positive", ER_mean, NA),
      ER_negative_mean = ifelse(unique(data$ER) == "Negative", ER_mean, NA),
      p_value = NA
    )
  }
  # Bind current result to the overall results data frame
  ER_mw_results <- rbind(ER_mw_results, result)
}

# Perform Benjamini-Hochberg correction
ER_mw_results$q_value <- p.adjust(ER_mw_results$p_value, method = "BH")

```

## PR Positive vs Negative- NEW 

```{r}
# Loop through each unique location and perform Mann-Whitney test
for (event in unique_locations) {
  # Filter data for the current event
  data <- merged_PSI_ER_PR_HER2 %>%
    filter(Location == event) %>%
    na.omit()
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    missing_events <- rbind(missing_events, data.frame(event = event))
    next
    
  } else if (length(unique(data$PR)) == 2) {
    # Perform Mann-Whitney test with handling ties
    mw_test <- wilcox.test(PSI_Score ~ PR, data = data, exact = FALSE)
    
    # Calculate means for PR in positive and negative groups
    PR_positive_mean <- mean(data$PSI_Score[data$PR == "Positive"])  
    PR_negative_mean <- mean(data$PSI_Score[data$PR == "Negative"])
    
    # Write results to data frame
    result <- data.frame(
      Location = event,
      PR_positive_mean = PR_positive_mean,
      PR_negative_mean = PR_negative_mean,
      p_value = mw_test$p.value
    )
  } else if (length(unique(data$PR)) == 1) {
    # Calculate mean PSI score for the single PR value
    PR_mean <- mean(data$PSI_Score)
    
    # Write results to data frame with NA for other columns
    result <- data.frame(
      Location = event,
      PR_positive_mean = ifelse(unique(data$ER) == "Positive", PR_mean, NA),
      PR_negative_mean = ifelse(unique(data$ER) == "Negative", PR_mean, NA),
      p_value = NA
    )
  }
  # Bind current result to the overall results data frame
  PR_mw_results <- rbind(PR_mw_results, result)
}

# Perform Benjamini-Hochberg correction
PR_mw_results$q_value <- p.adjust(PR_mw_results$p_value, method = "BH")

```
## HER2 Positive vs Negative- NEW 

```{r}
# Loop through each unique location and perform Mann-Whitney test
for (event in unique_locations) {
  # Filter data for the current event
  data <- merged_PSI_ER_PR_HER2 %>%
    filter(Location == event) %>%
    na.omit()
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    missing_events <- rbind(missing_events, data.frame(event = event))
    next
    
  } else if (length(unique(data$HER2)) == 2) {
    # Perform Mann-Whitney test with handling ties
    mw_test <- wilcox.test(PSI_Score ~ HER2, data = data, exact = FALSE)
    
    # Calculate means for HER2 in positive and negative groups
    HER2_positive_mean <- mean(data$PSI_Score[data$HER2 == "Positive"])  
    HER2_negative_mean <- mean(data$PSI_Score[data$HER2 == "Negative"])
    
    # Write results to data frame
    result <- data.frame(
      Location = event,
      HER2_positive_mean = HER2_positive_mean,
      HER2_negative_mean = HER2_negative_mean,
      p_value = mw_test$p.value
    )
  } else if (length(unique(data$HER2)) == 1) {
    # Calculate mean PSI score for the single HER2 value
    HER2_mean <- mean(data$PSI_Score)
    
    # Write results to data frame with NA for other columns
    result <- data.frame(
      Location = event,
      HER2_positive_mean = ifelse(unique(data$HER2) == "Positive", HER2_mean, NA),
      HER2_negative_mean = ifelse(unique(data$HER2) == "Negative", HER2_mean, NA),
      p_value = NA
    )
  }
  # Bind current result to the overall results data frame
  HER2_mw_results <- rbind(HER2_mw_results, result)
}

# Perform Benjamini-Hochberg correction
HER2_mw_results$q_value <- p.adjust(HER2_mw_results$p_value, method = "BH")

```

## PR Positive vs Negative: Old version 

```{r}
# Loop through each unique location and perform Mann-Whitney test
for (event in events_1) {
  # Filter data for the current event
  data <- location_subset1 %>%
    filter(Location == event) %>%
    na.omit()
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    next
    
  } else if (length(unique(data$PR)) == 2) {
    # Perform Mann-Whitney test with handling ties
    mw_test <- wilcox.test(PSI_Score ~ PR, data = data, exact = FALSE)
    
    # Calculate means for PR in positive and negative groups
    PR_positive_mean <- mean(data$PSI_Score[data$PR == "Positive"])  
    PR_negative_mean <- mean(data$PSI_Score[data$PR == "Negative"])
    
    # Write results to data frame
    result <- data.frame(
      Location = event,
      PR_positive_mean = PR_positive_mean,
      PR_negative_mean = PR_negative_mean,
      p_value = mw_test$p.value
    )
  } else if (length(unique(data$PR)) == 1) {
    # Calculate mean PSI score for the single PR value
    PR_mean <- mean(data$PSI_Score)
    
    # Write results to data frame with NA for other columns
    result <- data.frame(
      Location = event,
      PR_positive_mean = ifelse(unique(data$PR) == "Positive", PR_mean, NA),
      PR_negative_mean = ifelse(unique(data$PR) == "Negative", PR_mean, NA),
      p_value = NA
    )
  }
  # Bind current result to the overall results data frame
  PR_mw_results <- rbind(PR_mw_results, result)
}

# Repeat for loop for second subset
for (event in events_2) {
  # Filter data for the current event
  data <- location_subset2 %>%
    filter(Location == event) %>%
    na.omit()
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    next
    
  } else if (length(unique(data$PR)) == 2) {
    # Perform Mann-Whitney test with handling ties
    mw_test <- wilcox.test(PSI_Score ~ PR, data = data, exact = FALSE)
    
    # Calculate means for PR in positive and negative groups
    PR_positive_mean <- mean(data$PSI_Score[data$PR == "Positive"])  
    PR_negative_mean <- mean(data$PSI_Score[data$PR == "Negative"])
    
    # Write results to data frame
    result <- data.frame(
      Location = event,
      PR_positive_mean = PR_positive_mean,
      PR_negative_mean = PR_negative_mean,
      p_value = mw_test$p.value
    )
  } else if (length(unique(data$PR)) == 1) {
    # Calculate mean PSI score for the single PR value
    PR_mean <- mean(data$PSI_Score)
    
    # Write results to data frame with NA for other columns
    result <- data.frame(
      Location = event,
      PR_positive_mean = ifelse(unique(data$PR) == "Positive", PR_mean, NA),
      PR_negative_mean = ifelse(unique(data$PR) == "Negative", PR_mean, NA),
      p_value = NA
    )
  }
  # Bind current result to the overall results data frame
  PR_mw_results <- rbind(PR_mw_results, result)
}

# Perform Benjamini-Hochberg correction
PR_mw_results$q_value <- p.adjust(PR_mw_results$p_value, method = "BH")

```

## HER2 Positive vs Negative: Old version 

```{r}
# Loop through each unique location and perform Mann-Whitney test
for (event in events_1) {
  # Filter data for the current event
  data <- location_subset1 %>%
    filter(Location == event) %>%
    na.omit()
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    next
    
  } else if (length(unique(data$HER2)) == 2) {
    # Perform Mann-Whitney test with handling ties
    mw_test <- wilcox.test(PSI_Score ~ HER2, data = data, exact = FALSE)
    
    # Calculate means for PR in positive and negative groups
    HER2_positive_mean <- mean(data$PSI_Score[data$HER2 == "Positive"])  
    HER2_negative_mean <- mean(data$PSI_Score[data$HER2 == "Negative"])
    
    # Write results to data frame
    result <- data.frame(
      Location = event,
      HER2_positive_mean = HER2_positive_mean,
      HER2_negative_mean = HER2_negative_mean,
      p_value = mw_test$p.value
    )
  } else if (length(unique(data$HER2)) == 1) {
    # Calculate mean PSI score for the single PR value
    HER2_mean <- mean(data$PSI_Score)
    
    # Write results to data frame with NA for other columns
    result <- data.frame(
      Location = event,
      HER2_positive_mean = ifelse(unique(data$HER2) == "Positive", HER2_mean, NA),
      HER2_negative_mean = ifelse(unique(data$HER2) == "Negative", HER2_mean, NA),
      p_value = NA
    )
  }
  # Bind current result to the overall results data frame
  HER2_mw_results <- rbind(HER2_mw_results, result)
}

# Repeat for loop for second subset
for (event in events_2) {
  # Filter data for the current event
  data <- location_subset2 %>%
    filter(Location == event) %>%
    na.omit()
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    next
    
  } else if (length(unique(data$HER2)) == 2) {
    # Perform Mann-Whitney test with handling ties
    mw_test <- wilcox.test(PSI_Score ~ HER2, data = data, exact = FALSE)
    
    # Calculate means for PR in positive and negative groups
    HER2_positive_mean <- mean(data$PSI_Score[data$HER2 == "Positive"])  
    HER2_negative_mean <- mean(data$PSI_Score[data$HER2 == "Negative"])
    
    # Write results to data frame
    result <- data.frame(
      Location = event,
      HER2_positive_mean = HER2_positive_mean,
      HER2_negative_mean = HER2_negative_mean,
      p_value = mw_test$p.value
    )
  } else if (length(unique(data$HER2)) == 1) {
    # Calculate mean PSI score for the single PR value
    HER2_mean <- mean(data$PSI_Score)
    
    # Write results to data frame with NA for other columns
    result <- data.frame(
      Location = event,
      HER2_positive_mean = ifelse(unique(data$HER2) == "Positive", HER2_mean, NA),
      HER2_negative_mean = ifelse(unique(data$HER2) == "Negative", HER2_mean, NA),
      p_value = NA
    )
  }
  # Bind current result to the overall results data frame
  HER2_mw_results <- rbind(HER2_mw_results, result)
}

# Perform Benjamini-Hochberg correction
HER2_mw_results$q_value <- p.adjust(HER2_mw_results$p_value, method = "BH")

```

## Summary of Mann-Whitney Tests

```{r}
ER_mw_results %>%
  filter(q_value < 0.05) %>%
  count() #2081 -> 1418

PR_mw_results %>%
  filter(q_value < 0.05) %>%
  count() #1233 -> 906

HER2_mw_results %>%
  filter(q_value < 0.05) %>%
  count() #638 -> 466

ER_mw_gene_results <- left_join(ER_mw_results, gene_names, by = "Location")
PR_mw_gene_results <- left_join(PR_mw_results, gene_names, by = "Location")
HER2_mw_gene_results <- left_join(HER2_mw_results, gene_names, by = "Location")

ER_mw_gene_results %>%
  filter(q_value < 0.05) %>%
  group_by(Gene_Name) %>%
  count() #347 -> 287

PR_mw_gene_results %>%
  filter(q_value < 0.05) %>%
  group_by(Gene_Name) %>%
  count() #271 -> 223

HER2_mw_gene_results %>%
  filter(q_value < 0.05) %>%
  group_by(Gene_Name) %>%
  count() #163 -> 149

```

## Kruskal-Wallis Test: Molecular Subtypes 

```{r}
KW_summary_stats <- group_by(merged_PSI_ER_PR_HER2, NCN_PAM50) %>%
  summarise(
    count = n_distinct(Sample),
    mean = mean(PSI_Score, na.rm = TRUE),
    sd = sd(PSI_Score, na.rm = TRUE),
    median = median(PSI_Score, na.rm = TRUE),
    IQR = IQR(PSI_Score, na.rm = TRUE)
  )

# Initialize dataframe
KW_results <- data.frame(
  Location = character(),
  LumA_mean = double(),
  LumB_mean = double(),
  Basal_mean = double(),
  HER2_mean = double(),
  Normal_mean = double(),
  p_value = double(),
  q_value = double(),
  stringsAsFactors = FALSE
)

# Initialize an empty dataframe to store events with only 1 observation
missing_events_kw <- data.frame(event = character(), stringsAsFactors = FALSE)

# Initialize an empty data frame to store results
KW_results <- data.frame()

# Loop through each unique location and perform Kruskal-Wallis test
for (event in unique_locations) {
  # Filter data for the current event
  data <- merged_PSI_ER_PR_HER2 %>%
    na.omit() %>%
    filter(Location == event) 
    #filter(NCN_PAM50 != "unclassified") # remove unclassified samples 
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    missing_events_kw <- rbind(missing_events_kw, data.frame(event = event))
    next
  }
  
  # Check if each group has at least 20 non-NA samples
  group_counts <- table(data$NCN_PAM50)
  if(all(group_counts >= 20)) {
    # Perform Kruskal-Wallis test with handling ties
    data$NCN_PAM50 <- as.factor(data$NCN_PAM50) 
    data$PSI_Score <- as.numeric(data$PSI_Score)
    k_test <- kruskal.test(PSI_Score ~ NCN_PAM50, data = data)
    
    # Calculate means for ER in positive and negative groups
    LumA_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "LumA"])  
    LumB_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "LumB"])  
    Basal_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "Basal"])  
    HER2_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "Her2"])  
    Normal_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "Normal"])  
    
    # Create a result data frame
    result <- data.frame(
      Location = event,
      LumA_mean = LumA_mean,
      LumB_mean = LumB_mean,
      Basal_mean = Basal_mean,
      HER2_mean = HER2_mean,
      Normal_mean = Normal_mean,
      p_value = k_test$p.value,
      stringsAsFactors = FALSE
    )
    
    # Bind current result to the overall results data frame
    KW_results <- rbind(KW_results, result)
  } else {
    print(paste("Skipping", event, "due to insufficient samples in one or more groups."))
  }
}

# Perform Benjamini-Hochberg correction (decrease FDR)
KW_results$q_value <- p.adjust(KW_results$p_value, method = "BH")
KW_with_genes <- left_join(KW_results, gene_names, by = "Location")

```

## Closer look at significant results
```{r}
KW_with_genes %>%
  filter(q_value < 0.05) %>%
  group_by(Gene_Name) %>%
  count() #397 genes -> 169

KW_with_genes %>%
  filter(q_value < 0.05) %>%
  count() #3382 events -> 784

# Subset significant results
significant_results <- subset(KW_with_genes, q_value < 0.05)
mean_diff <- significant_results %>%
  summarise(
    LumA_LumB = LumA_mean - LumB_mean,
    LumA_Basal = LumA_mean - Basal_mean,
    LumA_HER2 = LumA_mean - HER2_mean,
    LumA_Normal = LumA_mean - Normal_mean,
    LumB_Basal = LumB_mean - Basal_mean,
    LumB_HER2 = LumB_mean - HER2_mean,
    LumB_Normal = LumB_mean - Normal_mean,
    Basal_HER2 = Basal_mean - HER2_mean,
    Basal_Normal = Basal_mean - Normal_mean,
    HER2_Normal = HER2_mean - Normal_mean,
  )

# Create a histogram of delta mean

install.packages("geomtextpath")
library(geomtextpath)
library(hrbrthemes)

# Plot histograms
mean_diff$labels = ifelse(mean_diff$Basal_HER2 <0, "<", ">")
ggplot(mean_diff, aes(x = Basal_HER2, colour = as.factor(labels), label = as.factor(labels))) +
  geom_textdensity() +
  xlim(c(-0.2, 0.2)) +
  theme_bw() 


# Look at AS Type 
event_types <- AS_events %>%
  select(Location, AS_Type)

significant_results <- left_join(significant_results, event_types, by = "Location")

significant_results %>%
  group_by(AS_Type) %>%
  count()
```

## Pairwise Kruskal-Wallis? 
```{r}
# Create empty dataframes to store results
pair_results <- data.frame(
  Location = character(),
  p_value = double(),
  q_value = double()
)

# Initialize dataframes
pair_results <- data.frame(Location = character(),
                            p_value = numeric())

# Initialize an empty dataframe to store events with only 1 observation
missing_events_pair <- data.frame(event = character(), stringsAsFactors = FALSE)

# Loop through each unique location and perform Kruskal-Wallis test
for (event in events_1) {
  # Filter data for the current event
  data <- location_subset1 %>%
    na.omit() %>%
    filter(Location == event) %>%
    filter(NCN_PAM50 != "unclassified") # remove unclassified samples 
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    missing_events_pair <- rbind(missing_events_pair, data.frame(event = event))
    next
    
  } else if (length(unique(data$NCN_PAM50)) == 5) {
    # Perform Kruskal-Wallis test with handling ties
    data$NCN_PAM50 <- as.factor(data$NCN_PAM50) 
    data$PSI_Score <- as.numeric(data$PSI_Score)
    pair_test <- pairwise.wilcox.test(data$PSI_Score, data$NCN_PAM50,
                 p.adjust.method = "BH")
    
    # Create a result data frame
    result <- data.frame(
      Location = event,
      p_value = pair_test$p.value,
      stringsAsFactors = FALSE
    )
  } 
  # Bind current result to the overall results data frame
  pair_results <- rbind(pair_results, result)
}

# Second subset 
for (event in events_2) {
  # Filter data for the current event
  data <- location_subset2 %>%
    na.omit() %>%
    filter(Location == event) %>%
    filter(NCN_PAM50 != "unclassified") # remove unclassified samples 
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    missing_events_pair <- rbind(missing_events_pair, data.frame(event = event))
    next
    
  } else if (length(unique(data$NCN_PAM50)) == 5) {
    # Perform Kruskal-Wallis test with handling ties
    data$NCN_PAM50 <- as.factor(data$NCN_PAM50) 
    data$PSI_Score <- as.numeric(data$PSI_Score)
    pair_test <- pairwise.wilcox.test(data$PSI_Score, data$NCN_PAM50,
                 p.adjust.method = "BH")
    
    # Create a result data frame
    result <- data.frame(
      Location = event,
      p_value = pair_test$p.value,
      stringsAsFactors = FALSE
    )
  } 
  # Bind current result to the overall results data frame
  pair_results <- rbind(pair_results, result)
}

```
## Extra Stuff- delete later 
```{r}
# Count rows where all values are 0s or 1s:
count_all_zeros <- sum(apply(converted_PSI_scores[, column_range], 1, function(row) all(row == 0, na.rm = TRUE))) # 3274 rows

count_all_ones <- sum(apply(converted_PSI_scores[, column_range], 1, function(row) all(row == 1, na.rm = TRUE))) # 762 rows 

total_count <- count_all_zeros + count_all_ones # 4036 rows 

# Count rows where all values are NA:
count_all_na <- sum(apply(converted_PSI_scores[, column_range], 1, function(row) all(is.na(row)))) # 402 rows 

# Count rows where all values are the same:
count_all_same <- sum(apply(converted_PSI_scores[, column_range], 1, function(row) length(unique(na.omit(row))) == 1)) # 3265 rows 

## Mann-Whitney Test- OVERALL (NOT PER EVENT)
# Perform Mann-Whitney tests for each variable
wilcox_results <- list(
    ER = wilcox.test(PSI_Score ~ ER, data = na.omit(merged_PSI_ER_PR_HER2)),
    PR = wilcox.test(PSI_Score ~ PR, data = na.omit(merged_PSI_ER_PR_HER2)),
    HER2 = wilcox.test(PSI_Score ~ HER2, data = na.omit(merged_PSI_ER_PR_HER2))
)

# Create a data frame to store results
results_df <- data.frame(
    Variable = c("ER", "PR", "HER2"),
    p_value = sapply(wilcox_results, function(x) x$p.value)
)

# Correct p-values for multiple testing
results_df$q_value <- p.adjust(results_df$p_value, method = "BH")

# Display the corrected p-values
print(results_df)

# ORIGINAL MANN WHIT SETUP 
# Randomly select unique events for subset 1
events_subset1 <- sample(unique_locations, size = 8743, replace = FALSE)

# Remaining unique events for subset 2
events_subset2 <- setdiff(unique_locations, events_subset1) # 8743 events
events_subset2_strict <- setdiff(unique_locations_strict, events_subset1_strict)
# Filter the dataset to contain only samples from the selected locations
location_subset1 <- merged_PSI_ER_PR_HER2[merged_PSI_ER_PR_HER2$Location %in% events_subset1, ]

location_subset1_strict <- merged_PSI_ER_PR_HER2[merged_PSI_ER_PR_HER2$Location %in% events_subset1_strict, ]

location_subset2 <- merged_PSI_ER_PR_HER2[merged_PSI_ER_PR_HER2$Location %in% events_subset2, ]

location_subset2_strict <- merged_PSI_ER_PR_HER2[merged_PSI_ER_PR_HER2$Location %in% events_subset2_strict, ]

# List of events to loop through 
events_1 <- unique(location_subset1$Location)
events_2 <- unique(location_subset2$Location)

events_1_strict <- unique(location_subset1_strict$Location)
events_2 <- unique(location_subset2$Location)

# Repeat for loop for second subset 
for (event in events_2) {
  # Filter data for the current event
  data <- location_subset2 %>%
    na.omit() %>%
    filter(Location == event) %>%
    filter(NCN_PAM50 != "unclassified") # remove unclassified samples 
  
  # Check if there is only one observation, skip if true
  if (nrow(data) <= 1) {
    missing_events_kw <- rbind(missing_events_kw, data.frame(event = event))
    next
    
  } else if (length(unique(data$NCN_PAM50)) == 5) {
    # Perform Kruskal-Wallis test with handling ties
    data$NCN_PAM50 <- as.factor(data$NCN_PAM50) 
    data$PSI_Score <- as.numeric(data$PSI_Score)
    k_test <- kruskal.test(PSI_Score ~ NCN_PAM50, data = data)
    
    # Calculate means for ER in positive and negative groups
    LumA_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "LumA"])  
    LumB_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "LumB"])  
    Basal_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "Basal"])  
    HER2_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "Her2"])  
    Normal_mean <- mean(data$PSI_Score[data$NCN_PAM50 == "Normal"])  
    
    # Create a result data frame
    result <- data.frame(
      Location = event,
      LumA_mean = LumA_mean,
      LumB_mean = LumB_mean,
      Basal_mean = Basal_mean,
      HER2_mean = HER2_mean,
      Normal_mean = Normal_mean,
      p_value = k_test$p.value,
      stringsAsFactors = FALSE
    )
  } 
  # Bind current result to the overall results data frame
  KW_results <- rbind(KW_results, result)
}

```

```